name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Verify tag is on main branch
        run: |
          git fetch origin main
          if ! git merge-base --is-ancestor "$GITHUB_SHA" origin/main; then
            echo "::error::Tag must point to a commit on the main branch"
            exit 1
          fi
          echo "Tag is on main ✓"

      - name: Extract version from tag
        id: extract
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          echo "version=$TAG" >> "$GITHUB_OUTPUT"
          echo "Tag version: $TAG"

      - name: Verify all package versions match
        run: |
          TAG="${{ steps.extract.outputs.version }}"
          for pkg in sidekick-vscode/package.json sidekick-cli/package.json sidekick-shared/package.json; do
            PKG_VERSION=$(node -e "console.log(require('./$pkg').version)")
            if [[ "$PKG_VERSION" != "$TAG" ]]; then
              echo "::error::$pkg version ($PKG_VERSION) does not match tag (v$TAG)"
              exit 1
            fi
            echo "$pkg: $PKG_VERSION ✓"
          done

  publish-extension:
    name: Publish VS Code Extension
    runs-on: ubuntu-latest
    needs: validate

    defaults:
      run:
        working-directory: sidekick-vscode

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: sidekick-vscode/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Publish to Open VSX
        run: npx ovsx publish || echo "Already published or publish failed — continuing"
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: validate
    concurrency:
      group: pages
      cancel-in-progress: false
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - run: pip install zensical

      - run: zensical build

      - uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - id: deployment
        uses: actions/deploy-pages@v4

  publish-npm:
    name: Publish CLI to npm
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Build shared library
        working-directory: sidekick-shared
        run: npm ci && npm run build

      - name: Install CLI dependencies
        working-directory: sidekick-cli
        run: npm ci

      - name: Run CLI tests
        working-directory: sidekick-cli
        run: npm test

      - name: Build CLI
        working-directory: sidekick-cli
        run: npm run build

      - name: Verify binary
        working-directory: sidekick-cli
        run: node dist/sidekick-cli.mjs --version

      - name: Publish to npm (skip if already published)
        working-directory: sidekick-cli
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          if npm view "sidekick-agent-hub@$VERSION" version 2>/dev/null; then
            echo "Version $VERSION already published, skipping"
          else
            npm publish
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  build-binaries:
    name: Build ${{ matrix.target }} Binary
    runs-on: ${{ matrix.os }}
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
            ext: ''
          - os: ubuntu-24.04-arm
            target: linux-arm64
            ext: ''
          - os: macos-latest
            target: darwin-arm64
            ext: ''
          - os: macos-13
            target: darwin-x64
            ext: ''
          - os: windows-latest
            target: win-x64
            ext: '.exe'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Build shared library
        working-directory: sidekick-shared
        run: npm ci && npm run build

      - name: Install CLI dependencies
        working-directory: sidekick-cli
        run: npm ci

      - name: Build CJS bundle for SEA
        working-directory: sidekick-cli
        run: node esbuild-sea.cjs

      - name: Generate SEA blob
        working-directory: sidekick-cli
        run: node --experimental-sea-config sea-config.json

      - name: Create SEA binary (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: sidekick-cli
        run: |
          cp "$(command -v node)" "dist/sidekick${{ matrix.ext }}"
          npx postject "dist/sidekick${{ matrix.ext }}" NODE_SEA_BLOB dist/sea-prep.blob \
            --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2 \
            $(if [[ "$(uname)" == "Darwin" ]]; then echo "--macho-segment-name NODE_SEA"; fi)

      - name: Create SEA binary (Windows)
        if: runner.os == 'Windows'
        working-directory: sidekick-cli
        shell: pwsh
        run: |
          $nodePath = (Get-Command node).Source
          Copy-Item $nodePath "dist/sidekick.exe"
          # Remove signature so postject can modify the binary
          signtool remove /s "dist/sidekick.exe" 2>$null; $true
          npx postject "dist/sidekick.exe" NODE_SEA_BLOB dist/sea-prep.blob `
            --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2

      - name: Verify binary runs
        working-directory: sidekick-cli
        run: ./dist/sidekick${{ matrix.ext }} --version

      - name: Compress binary (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: sidekick-cli
        run: |
          tar -czf "dist/sidekick-${{ matrix.target }}.tar.gz" -C dist "sidekick${{ matrix.ext }}"

      - name: Compress binary (Windows)
        if: runner.os == 'Windows'
        working-directory: sidekick-cli
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/sidekick.exe" -DestinationPath "dist/sidekick-${{ matrix.target }}.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.target }}
          path: |
            sidekick-cli/dist/sidekick-*.tar.gz
            sidekick-cli/dist/sidekick-*.zip
          retention-days: 1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    if: always() && needs.validate.result == 'success'
    needs: [validate, publish-npm, build-binaries]

    steps:
      - uses: actions/checkout@v4

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: release-assets
          merge-multiple: true

      - name: Generate checksums
        working-directory: release-assets
        run: |
          sha256sum sidekick-* > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Extract changelog section
        id: changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          # Try to extract section for this version from CHANGELOG.md
          if [[ -f CHANGELOG.md ]]; then
            SECTION=$(sed -n "/^## .*${VERSION}/,/^## /p" CHANGELOG.md | head -n -1)
            if [[ -n "$SECTION" ]]; then
              echo "body<<EOF" >> "$GITHUB_OUTPUT"
              echo "$SECTION" >> "$GITHUB_OUTPUT"
              echo "EOF" >> "$GITHUB_OUTPUT"
            else
              echo "body=Release v${VERSION}" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "body=Release v${VERSION}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.validate.outputs.version }}
          body: |
            ${{ steps.changelog.outputs.body }}

            ## Install

            **npm** (requires Node.js 20+):
            ```
            npm i -g sidekick-agent-hub
            ```

            **Standalone binary** (no Node.js required):
            Download the binary for your platform below, extract, and add to your PATH.

            ## Checksums
            ```
            $(cat release-assets/SHA256SUMS.txt)
            ```
          files: |
            release-assets/sidekick-*.tar.gz
            release-assets/sidekick-*.zip
            release-assets/SHA256SUMS.txt
          fail_on_unmatched_files: false
